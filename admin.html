<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Panel de Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* VARIABLES NEON */
    :root {
      --neon-blue: #00ffff;
      --neon-green: #39ff14;
      --neon-red: #ff073a;
      --bg-dark: #0a0a2a;
      --box-dark: #1a1a4a;
      --input-dark: #2a2a6a;
      --shadow-intensity: 0.6;
    }

    body {
      background: var(--bg-dark);
      color: #fff;
      font-family: 'Poppins', sans-serif;
      padding: 20px;
      text-shadow: 0 0 5px var(--neon-blue), 0 0 10px var(--neon-blue);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      flex-direction: column;
    }

    /* ESTILOS DE CAJAS Y TITULOS */
    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: var(--neon-blue);
      text-shadow: 0 0 7px var(--neon-blue), 0 0 15px var(--neon-blue), 0 0 20px var(--neon-blue);
    }

    .box, .list, #loginContainer, #deniedContainer {
      background: var(--box-dark);
      border-radius: 16px;
      padding: 30px;
      max-width: 450px; /* Reducción de ancho para el login */
      margin: 0 auto 20px auto;
      box-shadow:
        0 0 10px var(--neon-blue),
        0 0 20px var(--neon-blue) inset;
      border: 1px solid var(--neon-blue);
    }

    /* Ocultar el panel de admin por defecto */
    #adminPanel {
      display: none;
      max-width: 700px; /* Ancho original para el panel */
      width: 100%;
      position: relative; /* Necesario para posicionar el botón de logout */
    }

    /* ESTILOS DE FORMULARIO */
    label { display: block; margin-top: 15px; font-weight: 600; }
    
    input {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--neon-blue);
      margin-top: 8px;
      background: var(--input-dark);
      color: #fff;
      box-shadow: 0 0 5px var(--neon-blue) inset;
    }
    
    /* BOTONES BASE Y NEÓN */
    .btn {
      width: 100%; /* Botones de login/registro a ancho completo */
      margin-top: 20px;
      padding: 12px 15px;
      border: none;
      border-radius: 8px;
      color: var(--bg-dark);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease-in-out;
      background: var(--neon-green);
      box-shadow: 0 0 5px var(--neon-green), 0 0 15px var(--neon-green), 0 0 20px var(--neon-green);
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 0 7px var(--neon-green), 0 0 20px var(--neon-green), 0 0 30px var(--neon-green);
    }

    /* Botones de acción secundaria (Logout/Register) */
    .btn-secondary {
      background: var(--neon-red) !important;
      box-shadow: 0 0 5px var(--neon-red), 0 0 10px var(--neon-red);
      width: auto;
      margin-left: 10px;
    }
    .btn-secondary:hover {
        transform: translateY(-3px);
        box-shadow: 0 0 7px var(--neon-red), 0 0 20px var(--neon-red), 0 0 30px var(--neon-red);
    }

    /* Botón de Logout en el panel de admin */
    #logoutBtn {
        position: absolute;
        top: 20px;
        right: 20px;
        width: auto;
        margin-top: 0;
        margin-left: 0;
    }
    
    /* Botón de Publicaciones (nuevo) */
    #togglePostsBtn {
        width: auto;
        margin-top: 20px;
        margin-bottom: 20px; /* Separación de la lista */
        padding: 10px 15px;
        display: block; /* Para que tome el ancho y se centre si es necesario */
        margin-left: auto;
        margin-right: auto;
        max-width: 300px; /* Limitar ancho del botón */
    }

    /* ESTILOS DE ACCESO DENEGADO */
    #deniedContainer {
        text-align: center;
        border-color: var(--neon-red);
        box-shadow: 0 0 10px var(--neon-red), 0 0 20px var(--neon-red) inset;
    }
    #deniedContainer h2 {
        color: var(--neon-red);
        text-shadow: 0 0 7px var(--neon-red), 0 0 15px var(--neon-red);
    }
    
    /* ESTILOS INTERNOS DEL PANEL DE ADMIN (MANTENIDOS/AJUSTADOS) */
    .tasks { margin-top: 20px; }
    .task-item {
      background: var(--input-dark);
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      border-left: 5px solid var(--neon-blue);
      box-shadow: 0 0 5px var(--neon-blue);
    }
    .post {
      background: var(--box-dark);
      padding: 15px;
      border-radius: 10px;
      margin-top: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
      border: 1px solid rgba(0, 255, 255, 0.5);
      box-shadow: 0 0 7px rgba(0, 255, 255, 0.7);
    }
    .post-info { flex: 1; }
    .post-info h3 { margin-top: 0; color: var(--neon-blue); }
    .post .delete-btn {
      background: var(--neon-red);
      box-shadow: 0 0 5px var(--neon-red), 0 0 10px var(--neon-red);
      width: auto;
    }
    .post .edit-btn {
      background: var(--neon-green) !important;
      box-shadow: 0 0 5px var(--neon-green), 0 0 10px var(--neon-green);
      width: auto;
    }
    .post button:hover {
        transform: translateY(-3px);
    }
    .post img { display: none; }
    a.upload { display: none; }
    
    /* Ocultar el contenedor de publicaciones por defecto */
    #postsListContainer {
        display: none;
        width: 100%;
        max-width: 700px;
        margin: auto;
    }
  </style>
</head>
<body>

  <div id="deniedContainer" style="display:none;">
      <h2>Acceso Denegado</h2>
      <p>La cuota de administradores ha sido alcanzada. Solo los administradores registrados pueden acceder.</p>
  </div>

  <div id="loginContainer">
    <h1>Acceso de Administrador</h1>
    <label>Usuario</label>
    <input type="text" id="loginUser">

    <label>Contraseña</label>
    <input type="password" id="loginPass">
    
    <button class="btn" id="loginBtn">Iniciar Sesión</button>
    <button class="btn btn-secondary" id="registerBtn">Registrar</button>
    <p id="loginMessage" style="text-align:center; color: var(--neon-red); margin-top:15px;"></p>
  </div>

  <div id="adminPanel">
    <button class="btn btn-secondary" id="logoutBtn">Cerrar Sesión</button>
    <h1>Panel de Administración</h1>

    <div class="box" id="formBox">
      <label>Título</label>
      <input type="text" id="title">

      <label>Link de Descarga (Mediafire u otro)</label>
      <input type="text" id="download">

      <div class="tasks" id="tasksContainer"></div>
      <button class="btn" id="addTask">Agregar Botón (Ej: Unirse a TikTok)</button>

      <button class="btn" id="save">Guardar Publicación</button>
    </div>

    <button class="btn" id="togglePostsBtn">Mostrar Publicaciones</button>

    <div id="postsListContainer">
        <div class="list" id="postsList">
            <h2 style="text-align:center;">Publicaciones Existentes</h2>
            </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
    
    // Configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAQAfdb3O0GzkQTrpmqUmFq38szrf3PJhw",
      authDomain: "domini-6fae2.firebaseapp.com",
      projectId: "domini-6fae2",
      storageBucket: "domini-6fae2.firebasestorage.app",
      messagingSenderId: "990218506087",
      appId: "1:990218506087:web:a577eed88dea8882c0e9c2",
      databaseURL: "https://domini-6fae2-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // REFERENCIAS DE ELEMENTOS
    const loginContainer = document.getElementById('loginContainer');
    const adminPanel = document.getElementById('adminPanel');
    const deniedContainer = document.getElementById('deniedContainer');
    const loginUser = document.getElementById('loginUser');
    const loginPass = document.getElementById('loginPass');
    const loginMessage = document.getElementById('loginMessage');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const togglePostsBtn = document.getElementById('togglePostsBtn'); 
    const postsListContainer = document.getElementById('postsListContainer'); 

    // REFERENCIAS DEL PANEL DE ADMIN
    const tasksContainer = document.getElementById('tasksContainer');
    const addTaskBtn = document.getElementById('addTask');
    const saveBtn = document.getElementById('save');
    const postsList = document.getElementById('postsList');

    let tasks = [];
    let editingId = null;

    // --- FUNCIONES DE AUTENTICACIÓN ---

    const ADMINS_REF = ref(db, 'admins');

    async function checkAdminLimit() {
        const snapshot = await get(ADMINS_REF);
        return snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
    }

    function hashPassword(password) {
        // **NOTA DE SEGURIDAD:** Uso de btoa() no es seguro para producción.
        return btoa(password);
    }

    async function handleLogin() {
        const user = loginUser.value.trim();
        const pass = loginPass.value.trim();
        loginMessage.textContent = '';

        if (!user || !pass) {
            loginMessage.textContent = 'Usuario y contraseña son requeridos.';
            return;
        }

        try {
            const hashedPassword = hashPassword(pass);
            const snapshot = await get(ADMINS_REF);
            let adminFound = false;

            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    const admin = child.val();
                    if (admin.user === user && admin.pass === hashedPassword) {
                        adminFound = true;
                    }
                });
            }

            if (adminFound) {
                localStorage.setItem('admin_session', user);
                showAdminPanel();
            } else {
                loginMessage.textContent = 'Credenciales incorrectas.';
            }
        } catch (error) {
            console.error("Error al iniciar sesión:", error);
            loginMessage.textContent = 'Error al intentar iniciar sesión.';
        }
    }

    async function handleRegister() {
        const user = loginUser.value.trim();
        const pass = loginPass.value.trim();
        loginMessage.textContent = '';

        if (!user || !pass) {
            loginMessage.textContent = 'Usuario y contraseña son requeridos.';
            return;
        }

        const currentAdmins = await checkAdminLimit();

        if (currentAdmins >= 2) {
            showDeniedScreen();
            return;
        }

        try {
            const hashedPassword = hashPassword(pass);

            const snapshot = await get(ADMINS_REF);
            let userExists = false;
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    if (child.val().user === user) {
                        userExists = true;
                    }
                });
            }

            if (userExists) {
                loginMessage.textContent = 'El nombre de usuario ya está en uso.';
                return;
            }

            const newAdminRef = push(ADMINS_REF);
            await set(newAdminRef, { user, pass: hashedPassword });
            
            localStorage.setItem('admin_session', user);
            alert('Registro exitoso. Iniciando sesión...');
            showAdminPanel();

        } catch (error) {
            console.error("Error al registrar:", error);
            loginMessage.textContent = 'Error al intentar registrar.';
        }
    }

    function handleLogout() {
        localStorage.removeItem('admin_session');
        window.location.reload();
    }

    // --- CONTROL DE VISTAS ---

    function showAdminPanel() {
        loginContainer.style.display = 'none';
        deniedContainer.style.display = 'none';
        adminPanel.style.display = 'block'; 
        postsListContainer.style.display = 'none'; // Asegurar que esté oculto al iniciar
        togglePostsBtn.textContent = 'Mostrar Publicaciones'; // Resetear texto del botón
    }

    function showLogin() {
        loginContainer.style.display = 'block';
        deniedContainer.style.display = 'none';
        adminPanel.style.display = 'none';
    }
    
    function showDeniedScreen() {
        loginContainer.style.display = 'none';
        deniedContainer.style.display = 'block';
        adminPanel.style.display = 'none';
    }

    async function checkSession() {
        const currentAdmins = await checkAdminLimit();
        const session = localStorage.getItem('admin_session');
        
        if (currentAdmins >= 2 && !session) {
             showDeniedScreen();
        } else if (session) {
            showAdminPanel();
        } else {
            showLogin();
        }
    }
    
    // --- LÓGICA DE MOSTRAR/OCULTAR PUBLICACIONES ---
    
    function togglePosts() {
        if (postsListContainer.style.display === 'none' || postsListContainer.style.display === '') {
            // Mostrar publicaciones
            postsListContainer.style.display = 'block';
            togglePostsBtn.textContent = 'Ocultar Publicaciones';
            // Cargamos los posts solo cuando se muestran
            loadPosts(); 
        } else {
            // Ocultar publicaciones
            postsListContainer.style.display = 'none';
            togglePostsBtn.textContent = 'Mostrar Publicaciones';
        }
    }


    // --- LÓGICA DEL PANEL DE ADMINISTRACIÓN (CRUD) ---

    addTaskBtn.onclick = () => {
      const name = prompt('Nombre del botón (Ej: Unirse a YouTube)');
      const link = prompt('Link del botón');
      if (name && link) {
        tasks.push({ name, link });
        renderTasks();
      }
    };

    function renderTasks() {
      tasksContainer.innerHTML = '';
      tasks.forEach((t) => {
        const div = document.createElement('div');
        div.className = 'task-item';
        div.innerHTML = `${t.name} - <a href="${t.link}" target="_blank">${t.link}</a>`;
        tasksContainer.appendChild(div);
      });
    }

    saveBtn.onclick = () => {
      const title = document.getElementById('title').value;
      const download = document.getElementById('download').value;
      const image = ""; 

      if (!title || !download) {
        alert('Completa todos los campos');
        return;
      }

      const postData = { image, title, download, tasks };

      if (editingId) {
        const postRef = ref(db, 'posts/' + editingId);
        update(postRef, postData);
        alert('Publicación actualizada correctamente');
        editingId = null;
        saveBtn.textContent = 'Guardar Publicación';
      } else {
        const postRef = push(ref(db, 'posts'));
        set(postRef, postData);
        alert('Publicación guardada correctamente');
      }

      resetForm();
    };

    function resetForm() {
      document.getElementById('title').value = '';
      document.getElementById('download').value = '';
      tasks = [];
      renderTasks();
    }

    function loadPosts() {
        // La función onValue se mantendrá activa para actualizar la lista si se está viendo.
        onValue(ref(db, 'posts'), (snapshot) => {
            postsList.innerHTML = '<h2 style="text-align:center;">Publicaciones Existentes</h2>';
            snapshot.forEach(child => {
                const data = child.val();
                const id = child.key;
                const div = document.createElement('div');
                div.className = 'post';
                div.innerHTML = `
                    <div class="post-info">
                        <h3>${data.title}</h3>
                        <p>${data.tasks ? data.tasks.length : 0} botones</p>
                    </div>
                    <button class="edit-btn">Editar</button>
                    <button class="delete-btn">Eliminar</button>
                `;

                div.querySelector('.delete-btn').addEventListener('click', () => {
                    if (confirm('¿Seguro que deseas eliminar esta publicación?')) {
                        remove(ref(db, 'posts/' + id));
                    }
                });

                div.querySelector('.edit-btn').addEventListener('click', () => {
                    document.getElementById('title').value = data.title;
                    document.getElementById('download').value = data.download;
                    tasks = data.tasks || [];
                    renderTasks();
                    editingId = id;
                    saveBtn.textContent = 'Guardar Cambios';
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });

                postsList.appendChild(div);
            });
        });
    }

    // --- LISTENERS E INICIO ---
    loginBtn.addEventListener('click', handleLogin);
    registerBtn.addEventListener('click', handleRegister);
    logoutBtn.addEventListener('click', handleLogout);
    togglePostsBtn.addEventListener('click', togglePosts); 

    checkSession();
  </script>
</body>
</html>
